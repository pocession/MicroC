---
title: "The pipelie for identification of the differentially-interacted regions (DIRs)."
author: "Tsunghan Hsieh"
description: > This notebook demonstrates how I get DIRs from human samples treated with microbial molecules.
date: "`r format(Sys.Date(), format='%d-%m-%Y')`"
output:
 epuRate::epurate:
 toc: TRUE
 number_sections: TRUE
 code_folding: "show"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set up
***
```{r}
# Load functions.
devtools::document()
devtools::load_all()
```

# Library
***
```{r library}
library(edgeR)
```

# Set path
***

```{r path}
inputDir <- here::here("./Results/processing")
outputDir <- here::here("./Results/DIR")
```

# TODO
***
```{python todo}
# Before running this document, please run the following python script to subset hic data 
# and generate the position index file
# Example
# python ./Python/subset_hic_data.py --inputDir /data/44111_A_ctrl_43614_mc5contact_map.hic --outputDir /Results/processing/ --rowChr chr2 --columnChr chr2 --rowStart 112735986 --rowEnd 113204585 --columnStart 112735986 --columnEnd 113204585 --res 5000
```

# Read the input file
*** 

```{r input}
hicfiles <- list.files(path = inputDir, pattern = "_map_extracted\\.csv$", full.names = TRUE)
posfiles <- list.files(path = inputDir, pattern = "_map_PosIndex\\.txt$", full.names = TRUE)
```

# Generate the DIR
***
We will generate a series of DIR files. The first one is the differential analysis among cells from two healthy donors and this file will be used as a "black list" to filter out the individual-specific interacted regions. Other DIR files are human cells treated with microbial molecules vs untreated. Note we have no biological replicate for all experiment, therefore we assume biological covariance = 0.4 for the differential analysis.

## Healthy donors
***

```{r healthy}
df_healthy <- GetDIRWithNoReplicate(
chr = "chr2",
treat = here::here("./Results/processing/44111_A_ctrl_43614_mc5contact_map_extracted.csv"),
ctrl = here::here("./Results/processing/44113_C_ctrl_43616_mc7contact_map_extracted.csv"),
bcv = 0.4,
start_position_index = here::here("./Results/processing/44111_A_ctrl_43614_mc5contact_map_PosIndex.txt"),
output = here::here("./Results/DIR/healthy.csv")
)
```

## Other stimulating agents
***

```{r stimulating}
df_bg <- GetDIRWithNoReplicate(
chr = "chr2",
treat = here::here("./Results/processing/44112_A_bg_43615_mc6contact_map_extracted.csv"),
ctrl = here::here("./Results/processing/44111_A_ctrl_43614_mc5contact_map_extracted.csv"),
bcv = 0.4,
start_position_index = here::here("./Results/processing/44111_A_ctrl_43614_mc5contact_map_PosIndex.txt"),
output = here::here("./Results/DIR/bg.csv")
)

df_lps <- GetDIRWithNoReplicate(
chr = "chr2",
treat = here::here("./Results/processing/44114_C_lps_43617_mc8contact_map_extracted.csv"),
ctrl = here::here("./Results/processing/44113_C_ctrl_43616_mc7contact_map_extracted.csv"),
bcv = 0.4,
start_position_index = here::here("./Results/processing/44113_C_ctrl_43616_mc7contact_map_PosIndex.txt"),
output = here::here("./Results/DIR/lps.csv")
)

df_bcg <- GetDIRWithNoReplicate(
chr = "chr2",
treat = here::here("./Results/processing/BCG_contact_map_extracted.csv"),
ctrl = here::here("./Results/processing/DMSO_contact_map_extracted.csv"),
bcv = 0.4,
start_position_index = here::here("./Results/processing/DMSO_contact_map_PosIndex.txt"),
output = here::here("./Results/DIR/bcg.csv")
)

df_ldhi <- GetDIRWithNoReplicate(
chr = "chr2",
treat = here::here("./Results/processing/LDHi_contact_map_extracted.csv"),
ctrl = here::here("./Results/processing/DMSO_contact_map_extracted.csv"),
bcv = 0.4,
start_position_index = here::here("./Results/processing/DMSO_contact_map_PosIndex.txt"),
output = here::here("./Results/DIR/ldhi.csv")
)

df_bcgldhi <- GetDIRWithNoReplicate(
chr = "chr2",
treat = here::here("./Results/processing/BCGLDHi_contact_map_extracted.csv"),
ctrl = here::here("./Results/processing/DMSO_contact_map_extracted.csv"),
bcv = 0.4,
start_position_index = here::here("./Results/processing/DMSO_contact_map_PosIndex.txt"),
output = here::here("./Results/DIR/bcgldhi.csv")
)
```

# Filter out the individual-specific DIRs
***

```{r filter_blacklist}
## looks like only a small fraction are individual-specific
df_blacklist <- df_healthy |>
  dplyr::filter(PValue < 0.05)
```
